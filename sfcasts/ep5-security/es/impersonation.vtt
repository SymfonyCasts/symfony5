WEBVTT

00:00:01.016 --> 00:00:04.786 align:middle
¿Alguna vez has tenido una situación en la
que estás ayudando a alguien en línea...

00:00:05.076 --> 00:00:10.756 align:middle
y sería mucho más fácil si pudieras
ver lo que está viendo en su pantalla...

00:00:11.076 --> 00:00:16.296 align:middle
o, mejor aún, si pudieras hacerte cargo
temporalmente y arreglar el problema tú mismo?

00:00:16.986 --> 00:00:20.756 align:middle
Sí, sólo tienes que hacer clic en el pequeño
icono del clip para adjuntar el archivo.

00:00:21.336 --> 00:00:23.416 align:middle
Debería estar como cerca
de la parte inferior...

00:00:23.826 --> 00:00:24.646 align:middle
un clip.

00:00:25.416 --> 00:00:27.386 align:middle
¿Qué es "adjuntar un archivo"?

00:00:27.946 --> 00:00:29.316 align:middle
Oh... es...

00:00:29.516 --> 00:00:31.166 align:middle
como enviar un "paquete"...

00:00:31.216 --> 00:00:32.286 align:middle
pero en Internet.

00:00:33.016 --> 00:00:34.156 align:middle
Ah, los recuerdos.

00:00:34.846 --> 00:00:38.756 align:middle
Symfony no puede ayudar a enseñar a tu familia
cómo adjuntar archivos a un correo electrónico.

00:00:39.136 --> 00:00:44.886 align:middle
Pero sí puede ayudar a tu personal de atención al cliente
mediante una función llamada suplantación de identidad.

00:00:45.706 --> 00:00:49.346 align:middle
Muy sencillo: esto da a
algunos usuarios el superpoder

00:00:49.346 --> 00:00:52.626 align:middle
de iniciar sesión
temporalmente como otra persona.

00:00:53.416 --> 00:00:54.026 align:middle
A continuación te explicamos cómo.

00:00:54.476 --> 00:00:56.336 align:middle
En primer lugar, tenemos
que activar la función.

00:00:56.776 --> 00:01:01.596 align:middle
En security.yaml, bajo nuestro cortafuegos
en algún lugar, añade switch_user: true:

00:01:02.516 --> 00:01:04.556 align:middle
Esto activa un nuevo autentificador.

00:01:05.106 --> 00:01:12.486 align:middle
Así que ahora tenemos nuestro CustomAuthenticator,
form_login, remember_me y también switch_user.

00:01:13.206 --> 00:01:13.906 align:middle
¿Cómo funciona?

00:01:13.906 --> 00:01:18.876 align:middle
Bien, ahora podemos "iniciar sesión" como
cualquier persona añadiendo ?_switch_user=

00:01:18.876 --> 00:01:24.106 align:middle
a la URL y luego una dirección
de correo electrónico.

00:01:25.016 --> 00:01:30.316 align:middle
Vuelve al archivo de accesorios -
src/Fixtures/AppFixtures.php - y desplázate hacia abajo.

00:01:31.246 --> 00:01:36.706 align:middle
Tenemos otro usuario cuyo correo electrónico
conocemos: es abraca_user@example.com:

00:01:37.506 --> 00:01:40.886 align:middle
Cópialo, pégalo al final de la URL y...

00:01:41.856 --> 00:01:43.326 align:middle
Acceso denegado.

00:01:43.876 --> 00:01:44.886 align:middle
Por supuesto

00:01:45.076 --> 00:01:47.366 align:middle
No podemos permitir que cualquiera haga esto.

00:01:48.046 --> 00:01:54.116 align:middle
El autentificador sólo lo permitirá si
tenemos un rol llamado ROLE_ALLOWED_TO_SWITCH.

00:01:54.676 --> 00:01:56.586 align:middle
Vamos a dárselo a nuestros
usuarios administradores.

00:01:57.176 --> 00:01:59.026 align:middle
Podemos hacerlo a través de role_hierarchy.

00:01:59.736 --> 00:02:04.326 align:middle
Aquí arriba, ROLE_ADMIN tiene
ROLE_COMMENT_ADMIN y ROLE_USER_ADMIN.

00:02:05.106 --> 00:02:07.636 align:middle
Vamos a darles también ROLE_ALLOWED_TO_SWITCH:

00:02:08.686 --> 00:02:09.626 align:middle
Y ahora...

00:02:11.676 --> 00:02:14.056 align:middle
¡guau! ¡Hemos cambiado de usuario!

00:02:14.476 --> 00:02:16.226 align:middle
¡Es un icono de usuario diferente!

00:02:16.696 --> 00:02:22.916 align:middle
Y lo más importante, abajo en la barra de herramientas
de depuración de la web, vemos abraca_user@example.com...

00:02:23.246 --> 00:02:26.316 align:middle
e incluso muestra quién
es el usuario original.

00:02:27.186 --> 00:02:31.346 align:middle
Entre bastidores, cuando introdujimos la
dirección de correo electrónico en la URL,

00:02:31.716 --> 00:02:34.776 align:middle
el autentificador switch_user la tomó

00:02:35.186 --> 00:02:39.496 align:middle
y luego aprovechó nuestro proveedor de
usuarios para cargar ese objeto User.

00:02:40.116 --> 00:02:44.996 align:middle
Recuerda: tenemos un proveedor de usuarios que
sabe cómo cargar usuarios de la base de datos

00:02:45.076 --> 00:02:47.676 align:middle
consultando su propiedad email:

00:02:48.316 --> 00:02:51.256 align:middle
Por eso usamos email en la URL.

00:02:52.116 --> 00:03:01.476 align:middle
Para "salir" y volver a nuestro usuario original,
añadimos de nuevo ?_switch_user= con el especial _exit.

00:03:02.156 --> 00:03:07.996 align:middle
Pero antes de hacer eso, una vez que una persona del servicio
de atención al cliente se ha cambiado a otra cuenta,

00:03:08.456 --> 00:03:11.646 align:middle
queremos asegurarnos de que
no olvida que se ha cambiado.

00:03:11.646 --> 00:03:17.316 align:middle
Así que vamos a añadir un indicador muy obvio a
nuestra página de que actualmente estamos "cambiados":

00:03:18.146 --> 00:03:20.236 align:middle
hagamos que el fondo de la cabecera sea rojo.

00:03:20.886 --> 00:03:24.546 align:middle
Abre el diseño base: templates/base.html.twig.

00:03:25.446 --> 00:03:26.226 align:middle
En la parte superior...

00:03:26.686 --> 00:03:28.116 align:middle
encuentra el body y el nav...

00:03:28.596 --> 00:03:30.676 align:middle
y lo dividiré en varias líneas.

00:03:31.846 --> 00:03:35.686 align:middle
¿Cómo podemos comprobar si
estamos suplantando a alguien?

00:03:36.326 --> 00:03:40.886 align:middle
Di is_granted() y pasa
esto ROLE_PREVIOUS_ADMIN.

00:03:41.766 --> 00:03:45.326 align:middle
Si estás suplantando a
alguien, tendrás este rol.

00:03:46.146 --> 00:03:49.666 align:middle
En ese caso, añade
style="background-color: red"...

00:03:50.166 --> 00:03:53.486 align:middle
con !important para anular
el estilo de la navegación:

00:03:54.346 --> 00:03:54.946 align:middle
¡Vamos a verlo!

00:03:55.546 --> 00:03:56.656 align:middle
Actualiza y...

00:03:57.376 --> 00:04:01.316 align:middle
¡ja! Esa es una pista muy obvia de
que estamos suplantando la identidad.

00:04:02.186 --> 00:04:05.486 align:middle
Para ayudar al usuario a detener la
suplantación, vamos a añadir un enlace.

00:04:06.106 --> 00:04:07.766 align:middle
Baja al menú desplegable.

00:04:09.536 --> 00:04:13.876 align:middle
Una vez más, comprueba si
is_granted('ROLE_PREVIOUS_ADMIN').

00:04:16.206 --> 00:04:17.356 align:middle
Copia el enlace de abajo...

00:04:18.116 --> 00:04:23.576 align:middle
pega... y envía al usuario a - app_homepage

00:04:23.986 --> 00:04:29.946 align:middle
pero pasa un parámetro extra
_switch_user establecido en _exit.

00:04:30.846 --> 00:04:36.466 align:middle
Si pasas algo al segundo argumento de
path() que no sea un comodín en la ruta,

00:04:36.806 --> 00:04:39.096 align:middle
Symfony lo establecerá
como parámetro de consulta.

00:04:39.616 --> 00:04:42.066 align:middle
Así que esto debería darnos
exactamente lo que queremos.

00:04:42.846 --> 00:04:45.856 align:middle
Para el texto, di "Salir de la suplantación":

00:04:46.646 --> 00:04:48.086 align:middle
¡Inténtalo! Refresca.

00:04:48.906 --> 00:04:50.856 align:middle
Es obvio que estamos suplantando...

00:04:51.316 --> 00:04:53.656 align:middle
pulsa "Salir de la suplantación" y...

00:04:53.956 --> 00:04:57.316 align:middle
volvemos a ser abraca_admin@example.com.

00:04:57.706 --> 00:05:05.526 align:middle
¡Qué bien! Por cierto, si necesitas más control sobre
los usuarios a los que se puede cambiar, puedes escuchar

00:05:05.906 --> 00:05:08.896 align:middle
el SwitchUserEvent.

00:05:09.726 --> 00:05:13.456 align:middle
Para evitar el cambio, lanza
un AuthenticationException.

00:05:14.046 --> 00:05:16.066 align:middle
Más adelante hablaremos de
los escuchadores de eventos.

00:05:16.946 --> 00:05:21.236 align:middle
A continuación: hagamos un pequeño descanso
para hacer algo totalmente divertido, pero...

00:05:21.316 --> 00:05:26.276 align:middle
que no está relacionado con la seguridad:
construir una ruta de usuario de la API
